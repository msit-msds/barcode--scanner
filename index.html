<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hybrid Scan Tool</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --primary: #007bff; --success: #28a745; --danger: #dc3545; --bg: #f4f7f6; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); padding: 20px; width: 100%; max-width: 400px; box-sizing: border-box; }
        #reader { width: 100%; border-radius: 8px; overflow: hidden; background: #000; border: 2px solid #333; margin-top: 10px; }
        #reader video { object-fit: cover !important; }
        .stats-bar { display: flex; justify-content: space-between; align-items: center; margin: 15px 0; font-weight: bold; }
        input { width: 100%; padding: 12px; margin: 8px 0; border: 2px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        button { width: 100%; padding: 14px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 5px; color: white; }
        .btn-start { background: var(--primary); }
        .btn-stop { background: var(--danger); }
        .btn-manual { background: var(--success); }
        .btn-undo { background: #6c757d; font-size: 0.8rem; padding: 8px; width: auto; }
        .last-scan { font-size: 0.8rem; color: #555; text-align: center; margin-bottom: 5px; min-height: 1.2rem; }
        .flash { animation: flash-green 0.3s; }
        @keyframes flash-green { from { background: #c3e6cb; } to { background: var(--bg); } }
    </style>
</head>
<body id="body">

<div class="card">
    <h3 style="margin:0 0 10px 0; text-align:center;">Module Session</h3>
    <input type="text" id="moduleInput" placeholder="Module # (e.g. MOD-101)">
    <button id="sessionBtn" class="btn-start">START SESSION</button>

    <div id="scannerUi" style="display:none;">
        <div id="reader"></div>
        <div class="stats-bar">
            <span>Count: <span id="count">0</span></span>
            <button id="undoBtn" class="btn-undo">UNDO LAST</button>
        </div>
        <div id="lastText" class="last-scan">Ready...</div>
        
        <input type="text" id="manualInput" placeholder="Manual Barcode">
        <button id="addManualBtn" class="btn-manual">ADD MANUAL</button>
    </div>
</div>

<script>
    let scannedData = [];
    let html5QrCode = new Html5Qrcode("reader");
    const sessionBtn = document.getElementById('sessionBtn');
    const moduleInput = document.getElementById('moduleInput');
    const scannerUi = document.getElementById('scannerUi');
    const countDisp = document.getElementById('count');
    const lastText = document.getElementById('lastText');

    sessionBtn.addEventListener('click', () => {
        if (!html5QrCode.isScanning) {
            if (!moduleInput.value.trim()) return alert("Enter Module #");
            start();
        } else {
            stop();
        }
    });

    async function start() {
        scannedData = [];
        updateCount();
        moduleInput.disabled = true;
        scannerUi.style.display = 'block';
        sessionBtn.innerText = "END & DOWNLOAD CSV";
        sessionBtn.className = "btn-stop";

        await html5QrCode.start(
            { facingMode: "environment" },
            { fps: 2, qrbox: { width: 250, height: 150 } },
            (code) => handleScan(code)
        ).catch(err => alert("Camera Error: Check HTTPS/Localhost"));
    }

    function handleScan(code) {
        // Prevent accidental double-scans within 1 second
        const now = Date.now();
        if (scannedData.length > 0 && scannedData[scannedData.length-1].code === code) {
             const lastTime = new Date(scannedData[scannedData.length-1].timestamp).getTime();
             if (now - lastTime < 1000) return; 
        }

        scannedData.push({ code, module: moduleInput.value, timestamp: new Date().toISOString() });
        updateCount();
        lastText.innerText = "Last: " + code;
        document.getElementById('body').classList.add('flash');
        setTimeout(() => document.getElementById('body').classList.remove('flash'), 300);
    }

    function updateCount() {
        countDisp.innerText = scannedData.length;
    }

    // --- UNDO FEATURE ---
    document.getElementById('undoBtn').addEventListener('click', () => {
        if (scannedData.length > 0) {
            const removed = scannedData.pop();
            updateCount();
            lastText.innerText = "Removed: " + removed.code;
        }
    });

    async function stop() {
        await html5QrCode.stop();
        downloadCSV();
        // Optional: syncToGoogleSheets(scannedData);
        
        scannerUi.style.display = 'none';
        moduleInput.disabled = false;
        sessionBtn.innerText = "START SESSION";
        sessionBtn.className = "btn-start";
    }

    function downloadCSV() {
        let csv = "Barcode,Module\n";
        scannedData.forEach(row => csv += `${row.code},${row.module}\n`);
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Session_${moduleInput.value}.csv`;
        a.click();
    }

    document.getElementById('addManualBtn').addEventListener('click', () => {
        const inp = document.getElementById('manualInput');
        if (inp.value) { handleScan(inp.value); inp.value = ""; }
    });
</script>
</body>
</html>
